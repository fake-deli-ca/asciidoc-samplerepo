include::../attribute.adoc[]

== クラウド環境の設定指針
***
=== 概要
このガイドラインでは、AlibabaCloudを利用します。

クラウド上には、下記2つのサーバを立ち上げます。

* Webアプリケーション用サーバ
** 開発するAPを配置します。

* SonarQube・Nexus用サーバ
** Nginxのリーバイスプロキシ制御下にSonarQubeとNexusを配置します。

また、各サーバへの接続はロードバランサによるパスルーティングによって振り分けます。

=== AlibabaCloudで設定することについて
==== VPC（Virtual Private Cloud）
AlibabaCloud上のプライベートネットワークです。 +
サーバを立ち上げる前に、まずはVPCを作成して他の仮想ネットワークからPJで扱う領域を分離します。 +

設定は、下図のようにAlibabaCloudサイトのVPCコンソールから行います。

image::fig_01.png[vpc, 640]

==== VSwith
VPC上のネットワークデバイスです。 +
後述するECS(仮想サーバ)やSLB(ロードバランサ)等のインスタンスはVSwith上に作成することになります。 +

設定は、VPC作成時にVPCコンソールから行う他、下図のようにVSwithコンソールから行います

image::fig_02.png[vpc, 640]

==== ECS（Elastic Compute Service）
AlibabaCloud上の仮想サーバがESCになります。 +
下図のようにESCコンソールより設定を行います。 +

image::fig_11.png[ecs, 640]

==== セキュリティグループ
ESCにアクセス可能なポート番号を設定します。 +
セキュリティグループに設定されていないポートは通信に使用することができません。 +
また、ポート毎にインバウンドおよびアウトバウンドのアクセス可否を設定することが可能です。 +
* インバウンド　：外部から内部への通信（外部PCからの自社サービスへのアクセス）
* アウトバウンド：内部から外部への通信（インスタンスからの外部システムへのアクセス）

image::fig_21.png[security_group, 640]

ESCの初期作成時には、下図のように「-1」「22/22」「3389/3389」ポートのみが利用可能となっているため、適宜編集が必要です。

image::fig_22.png[security_group, 640]

==== SLB（Server Load Balancer）
ロードバランサです。 +
下図のようにSLBコンソールよりSLBの購入を行います。

image::fig_51.png[slb, 640]

SLB購入後、「リスナーの作成」より振り分けの設定を行います。

image::fig_52.png[slb, 640]

image::fig_53.png[slb, 640]

また、「転送ルールの設定」よりパスルーティングを設定します。

image::fig_53.png[slb, 640]

=== 各サーバの構成について
このガイドラインで取り扱うサーバについてい説明します。
==== Webアプリケーション用サーバ
このサーバでは、開発したAPが配置されています。
* サーバスペック
サーバは下記のよう設定しています。

.サーバ
[cols="1,1,1,1,1", options="header"]
|=======================
|CPU
|メモリ
|OS
|帯域幅
|SSH接続

|1コア
|1GiB
|CentOS 7.7 64-bit
|1Mbps (ピーク値)
|キーペアによる公開鍵認証
|=======================

.セキュリティグループ
[cols="1,1,1", options="header"]
|=======================
|入力/出力
|ポート番号
|権限付与IPアドレス

|入力
|80/80
|0.0.0.0/0　※検証のためフルオープン
|=======================

* アプリケーション起動方式
APは、下図のようにAPを「Java -jar」コマンドにより起動するShellにより起動されます。

image::fig_31.png[web, 640]

また、AP起動Shellは下図のように「/etc/systemd/system」配下にサービス登録がされており、「systemctl enable」コマンドによりESCインスタンス起動時に自動実行されるようになっています。

image::fig_32.png[web, 640]

==== SonarQube・Nexus用サーバ
このサーバでは、CI/CDのパイプライン実行後にテスト結果とビルド資産を配置するためにSonarQubeとNexusが起動しています。
* サーバスペック
サーバは下記のよう設定しています。

.サーバ
[cols="1,1,1,1,1", options="header"]
|=======================
|CPU
|メモリ
|OS
|帯域幅
|SSH接続

|2コア
|4GiB
|CentOS 7.7 64-bit
|2Mbps (ピーク値)
|キーペアによる公開鍵認証
|=======================

.セキュリティグループ
[cols="1,1,1", options="header"]
|=======================
|入力/出力
|ポート番号
|権限付与IPアドレス

|入力
|80/80
|0.0.0.0/0　※検証のためフルオープン

|入力
|8080/8080
|0.0.0.0/0　※Nginxのポート番号
|=======================

* アプリケーション起動方式
SonarQubeとNexusはNginxによるリバースプロキシ制御下で起動しています。 +
各アプリケーションは、下図に示す設定でdocker起動しています。

image::fig_41.png[web, 640]

=== ネットワークの構成について
各サーバは、下記のようにSLBによるパスルーティングによって外部から接続するように設定しています。

.パスルーティング設定
[cols="1,1,1", options="header"]
|=======================
|ドメイン
|URL
|接続先ポート

|SLBのIP
|/nexus
|SonarQube・Nexus用サーバの8080番　※Nginxのポート番号

|SLBのIP
|/sonarqube
|SonarQube・Nexus用サーバの8080番　※Nginxのポート番号

|SLBのIP
|/web
|Webアプリケーション用サーバの80番
|=======================

[TIP]
====
SonarQube・Nexus用サーバではNginxのリバースプロキシにより、 +
「~/sonarqube」は9000番ポートに転送される　※SonarQubeのポート番号
また、「~/nexus」は8001番ポートに転送される　※Nexusのポート番号
====
