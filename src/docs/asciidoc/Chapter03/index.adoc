include::../attribute.adoc[]

== CI/CDツールの設定指針
***
=== 概要
* CI/CDツールでは、Github上の対象リポジトリについて、ブランチ毎に実行するパイプラインの処理（ビルド・テスト・デプロイ…etc）を指定します。
* SaaS型CI/CDツールを利用する場合、パイプラインで実行する処理は全て設定ファイルに記載し、設定ファイルを対象リポジトリのルートディレクトリ配下に配置することで、Githubでの動作を契機としてパイプラインが実行されます。

[TIP]
====
SaaS型ツールの代表例としては、特に運用事例の多い下記3ツールが挙げられますが、このガイドラインでは、初期構築のしやすさの観点から「CircleCI」を例として指針を提示します。  +

.SaaS型CI/CDツール
[cols="1,3,3,9", options="header"]
|=======================
|  |CI/CDツール  |URL                     |費用
|1 |Wercker     |https://app.wercker.com |無料  +
（Oracleが買収したため今後は不明）
|2 |TraviceCI   |https://travis-ci.org   |$118/month
|3 |CircleCI    |https://circleci.com    |基本無料（1環境、ビルド時間：1500分/月） +
1環境増設ごとに$50/月
|=======================
====

==== CI/CDで行うことについて
ローカル環境で作成・修正したアプリケーション（以降AP）に対して、下記の処理を自動実行します。

ビルドチェック:: ビルドツールによるビルドを行うことで、各種ライブラリとの依存関係が解消されており、APが実行環境で動作可能な状態であることを保証します。

テスト:: ローカル環境で使用したテストコードでビルドしたAPのJunitテストを行います。  +
また、SonarQubeによる静的検証（Checkstyle、SpotBugs）を行います。

ビルド資産の管理:: ビルドに成功したAPをNexusに登録することで、ビルド資産のバージョン管理を行います。

デプロイ:: ビルドに成功したAPを実行環境にデプロイします。

#### ブランチ戦略
アプリケーションはGitHubのリポジトリで管理し、状態毎に下記のブランチを切って管理を行います。

.ブランチ戦略
[cols="1,1,1,2", options="header"]
|=======================
|ブランチ        |ブランチ名        |説明                |作成/削除タイミング
|masterブランチ  |master           |常に最新版のブランチ |常に存在する
|issueブランチ   |issue<簡単な説明> |作業用のブランチ     |issueに基づいて、作業担当者がmasterブランチより作成する +
PRをmergeした際にレビュー担当者が削除する
|releaseブランチ |release          |リリース用のブランチ |リリースの際にライブラリ管理者がmasterブランチより作成する +
リリース完了後にライブラリ管理者が削除する
|=======================

#### タグによるリリースバージョン管理
アプリケーションのリリースバージョンはGitHubのタグで管理し、CI/CDのパイプライン内で下記の様式に従ってタグを生成する。

.タグ
[cols="1,8,2", options="header"]
|=======================
|ブランチ |タグ名                                                                    |作成タイミング
|master  |version-＜メジャーバージョン＞.＜マイナーバージョン＞.＜リビジョンバージョン＞-SNAPSHOT |PRをmergeした際
|master  |version-＜メジャーバージョン＞.＜マイナーバージョン＞.＜リビジョンバージョン＞-RELEASE  |releaseした際
|=======================

#### ブランチ毎のCI/CDフロー
パイプライン上ではブランチ毎に下記の処理を実行する。

[cols="2,6,7a", options="header"]
.CI/CDフロー
|===
|ブランチ
|パイプライン起動の契機
|実行処理

|issueブランチ
|ローカル環境よりGitHub上にpushした際
|
* ビルドチェック
* Junitテスト
* SonarQubeへのJunitテスト結果連携、静的検証

|masterブランチ
|PRをmergeした際
|
* ビルドチェック
* Junitテスト
* SonarQubeへのJunitテスト結果連携、静的検証
* Nexusへのライブラリ登録
* 最新のmasterブランチに対してタグ打ち +
（名：version-X.X.X-SNAPSHOT）

|releaseブランチ
|ローカル環境よりGitHub上にpushした際
|
* ビルドチェック
* Junitテスト
* Nexusへのライブラリ登録
* 最新のmasterブランチに対してタグ打ち +
（名：version-X.X.X-RELEASE）
|===

=== SonarQube連携について
* Junitテストの結果を連携する
* Checkstyleによる静的検証を実施する
* SpotBugsによる静的検証を実施する
* カバレッジ情報を表示する

=== Nexus連携について
* PRをmergeしたタイミングでSNAPSHOTリポジトリにビルド資産を連携する
* releaseブランチをGitHub上に作成したタイミングでRELEASEリポジトリにビルド資産を連携する

=== 設定ファイルで指定することについて
==== 設定ファイルの記載方法
 CircleCIの設定ファイル「config.yml」の基本構成は下記のようになっており、適宜PJの方針に合わせて必要な処理を記述する。
[TIP]
====
設定ファイルは、大きく下記の3ブロックより構成される。  +

. パイプラインブロック  +
→ Job単位で「どのコンテナ環境」を利用して、「どんな処理」を行うかを記述する。

. ワークフローブロック  +
→ 各Job間の前後関係・依存関係や各Jobの処理対象ブランチを記述する。

. 定時実行ワークフローブロック  +
→ cronベースで「どのタイミング」で起動するのか、またワークフローブロック同様に「どのJob」が「どんな依存関係」で「どのブランチ」を対象に処理するのかを記述する。
====

[source]
[caption="config.yml："]
.基本構成
----
### 基本構成
#CircleCIのバージョン指定
version: 2.1

#以下パイプラインの処理記述
jobs:
　build:
 　　#実行環境
 　　docker:
 　　　- image: Dockerイメージ

 　　#以下、処理「build」の実処理
 　　steps:
 　　　- checkout ※対象コードチェックアウト
 　　　- 処理②...
　deploy:
 　　docker:
 　　　- image: Dockerイメージ
 　　steps:
 　　　- checkout
 　　　- 処理②...

#以下ワークフローの記載
workflows:
　version: 2
　workflow:
　　jobs:
　　　- build:
  　　　　filters:
  　　　　　branches:
  　　　　　　only:
  　　　　　　　- 対象とするブランチ名
　　　　　post-steps:
　　　　　　- 定常実行処理
　　　- deploy:
  　　　　requires: ※先行処理
　　　　　　- build

#以下、定時実行ワークフローの記載
　nightly:
　　triggers:
　　　- schedule:
　　　　　cron: "25 * * * *"
　　　　　　filters:
　　　　　　　branches:
　　　　　　　　only:
  　　　　　　　　- master
　　jobs:
　　　- build:
　　　　　filters:
　　　　　　branches:
　　　　　　　only:
　　　　　　　　- /^issue\/.+/
　　　- deploy:
　　　　　requires:
　　　　　　- build
----

[TIP]
====
設定ファイル記述の詳細については、下記の公式ドキュメントを参照

* ＜CircleCI公式ドキュメント＞  +
https://circleci.com/docs/

特に下記ページを起点にすると、設定ファイル全体の内どの部分にあたる記述なのかをイメージしやすく、作業を効率よく進められます。

* 「CircleCIサイト＞リファレンスページURL」  +
https://circleci.com/docs/ja/2.0/configuration-reference/#section=reference
====

==== SonarQube連携方法
<1> build.gradleファイルに下記の記載を行う
<2> config.ymlファイルに下記の記載を行う

[source]
[caption="build.gradle："]
.sonarqubeプラグインの利用
-----
plugins {
  id "org.sonarqube" version "2.8"
}
…
sonarqube {
    properties {
        property "sonar.jacoco.reportPath", "${project.buildDir}/jacoco/test.exec"
    }
}
-----

[source]
[caption="config.yml："]
.sonarqubeタスクの呼び出し
-----
##"./gradlew sonarqube"コマンドによるSonerQubeサイトで設定した検証の実施と結果連携を行う。
jobs:
…
  sonarqube:
…
    steps:
      - checkout
      - run:
          name: analyze by SonarQube
          command: |
            ./gradlew clean sonarqube \
              -Dsonar.host.url=$SONAR_HOST_URL \
              -Dsonar.jdbc.url=$SONAR_JDBC_URL \
              -Dsonar.jdbc.driverClassName=$SONAR_JDBC_DRIVER \
              -Dsonar.jdbc.username=$SONAR_JDBC_USERNAME \
              -Dsonar.jdbc.password=$SONAR_JDBC_PASSWORD \
              -Dsonar.projectName="${CIRCLE_BRANCH}"_"${CIRCLE_BUILD_NUM}"
-----
[cols="2,7a,7a", options="header"]
.sonarqubeタスクのプロパティ
|===
|プロパティ
|説明
|変更要否

|sonar.jacoco.reportPath
|Jacocoが生成するレポートファイルへのパス +
[small]#※Jacoco：Java のコードカバレッジライブラリ#
|デフォルト値のため変更不要

|sonar.host.url
|接続先SonarQubのURL
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|sonar.jdbc.driverClassName
|SonarQubが利用するJDBCのドライバクラス名
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|sonar.jdbc.username
|SonarQubが利用するDBのユーザ名
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|sonar.jdbc.password
|SonarQubが利用するDBのパスワード
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|sonar.projectName
|SonarQubサイトで表示される名称
|今回は下記のCircleCIのデフォルト環境変数により自動で定義するようにしているため変更は不要 +

「CIRCLE_BRANCH」:: CI/CD対象のブランチ名

「CIRCLE_BUILD_NUM」:: CircleCI上のビルド回数
|===
SonarQub画面には下図のように表示される。

image::fig_51.png[sonarqube, 640]


[TIP]
====
sonarqubeタスクの詳細な記載方法は、下記公式ドキュメントを参照 +
https://docs.sonarqube.org/latest/analysis/scan/sonarscanner-for-gradle/
====

==== Nexus連携方法
<1> build.gradleファイルに下記の記載を行う
<2> config.ymlファイルに下記の記載を行う

[source]
[caption="build.gradle："]
.maven-publishプラグインの利用
-----
plugins {
  id "maven-publish"
}
…
group 'ビルド成果物のパッケージ名''
version '1.0.0-SNAPSHOT'
archivesBaseName = 'ビルド成果物のファイル名'
…
publishing {
    publications {
        mavenJava(MavenPublication) {
            groupId = group
            artifactId = archivesBaseName
            from components.java
        }
    }
    repositories {
        maven {
            url System.getenv("NEXUS_URL")
            credentials {
                username = System.getenv("NEXUS_USERNAME")
                password = System.getenv("NEXUS_USERPASSWORD")
            }
        }
    }
}
-----
[TIP]
====
publishingタスクの詳細な記載方法は、下記公式ドキュメントを参照
https://docs.gradle.org/current/userguide/publishing_maven.html#publishing_maven:complete_example
====

[source]
[caption="config.yml："]
.publishingタスクの呼び出し
-----
##"./gradlew upload"コマンドによるビルド成果物のNexus登録を行う。
jobs:
…
  nexus:
…
    steps:
      - checkout
      - run:
          name: upload to NEXUS
          command: |
            ./gradlew clean build publish
-----

[cols="2,6,7a", options="header"]
.publishingタスクのプロパティ
|===
|プロパティ
|説明
|変更要否

|groupId
|Nexusに登録する際のパッケージ名
|PJの設定に併せて変更する +
[small]#※このガイドラインでは、「group」の値を設定しています#

|artifactId
|Nexusに登録する際のファイル名
|PJの設定に併せて変更する +
[small]#※このガイドラインでは、「archivesBaseName」の値を設定しています#

|url
|接続先SonarQubのURL
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|username
|Nexusのログインユーザ名
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#

|password
|Nexusのログインパスワード
|PJの設定に併せて変更する +
[small]#※環境変数の設定については後述します#
|===

Nexus画面には下図のように表示される。

image::fig_61.png[nexus, 640]

==== 設定ファイルの配置
作成した設定ファイルは、ルートディレクトリ直下の「.circleci」ディレクトリ配下に配置することでGitHubへの操作を契機としCircleCIによりCI/CDのパイプラインが実行されます。

image::fig_01.png[github_rootdirectory, 640]


=== Webサイト(CircleCI)で指定することについて

* 「CircleCIサイトURL」 https://circleci.com +

ログイン方法等については、公式ドキュメントを参照 +
* ＜CircleCI公式ドキュメント＞  https://circleci.com/docs/

==== 対象リポジトリの登録
「Add Projects」よりCI/CD対象のリポジトリ登録を行います。 +
Github上のリポジトリの公開設定に関わらず登録が可能です。 +
また、後述する設定を行うことで自身が所属するOrganization所有のリポジトリを権限に応じて利用可能です。

1 ダッシュボード画面より「Add Projects」を選択する。

image::fig_11.png[add_repository, 640]


2 GitHub側の公開設定に関わらず、全リポジトリが表示されるので対象とするリポジトリを選択する。

image::fig_12.png[add_repository, 640]


3 ビルドツールを選択して、「Start Building」でリポジトリ登録を開始する。

image::fig_13.png[add_repository, 640]

4 「Start Building」を押すと下記のポップアップが表示されるので適宜「Add Manually」か「Add Config」を選択する。

image::fig_14.png[add_repository, 640]

[TIP]
====
「Add Config」を選択した場合、図に表示されているようにブランチが作成され、.circleci配下に設定ファイル（config.yml）が作成される。
その後、設定ファイルに基づいて初回のパイプライン実行が行われる。
 ※設定ファイルの内容は前画面で表示されたデフォルトの内容になるので、初回のパイプライン実行は上手くいかないことが多いです。
====
[TIP]
====
Add Manually」を選択した場合、下記のポップアップが表示されるので適宜設定ファイルを.circleci配下に準備してから「Start Building」をクリックする。 +
 ※下図にあるように「Download config.yml」で設定ファイルをダウンロードすることも可能です。 +
 ※設定ファイルの内容は、前画面で表示された内容のものです。

image::fig_15.png[add_repository, 640]
====

4 初期パイプライン実行が行われると、下図のように実行が表示される。

image::fig_16.png[add_repository, 640]

5 登録済みのリポジトリは「Set Up Project」ボタンが「Unfollow Project」ボタンに変わっているので、これを押すとリポジトリ登録が解除される。

image::fig_17.png[add_repository, 640]

==== 環境変数の登録
「config.yml」や「build.gradle」に記載した環境変数はパイプライン起動時にCircleCI画面で設定した値に自動的に置き換えられます。
[WARNING]
====
商用利用の場合、Githubはプライベートリポジトリで利用する想定ですが、パブリックリポジトリの場合はconfig.ymlの内容が不特定多数に公開されます。 +
そのため、特に理由がないのであればリポジトリの設定に関わらず [red]#秘匿情報は環境変数としてWeb-UIで設定すること#。
====

1 対象リポジトリのパイプライン画面より「Project Settings」を選択する。

image::fig_21.png[add_env, 640]


2 Project Settings画面で「Environment Variables」を選択して、「Add Config Variable」を押すことで環境変数と変数値を設定できる。 +
Project Settings画面で「Environment Variables」を選択して、「Add Config Variable」を押すことで環境変数と変数値を設定できる。

image::fig_22.png[add_env, 640]


3 「Add Config Variable」を押すと下記のポップアップが表示されるので、任意の環境変数と変数値を入力して「Add Environment Variable」を押す。 +
　既存の環境変数を入力すると変数値を置き換えることができる。

image::fig_23.png[add_env, 640]


4 「✕」を押すと下記のポップアップが表示されるので、テキストボックスに「DELETE」と入力して「Delete Environment Variable」を押す。

image::fig_24.png[add_env, 640]

[TIP]
====
自分で設定する環境変数以外にも、CircleCIデフォルトで準備されている環境変数が存在する。 +
それらについては、特に宣言することなく設定ファイル中で利用可能です。 +
詳細は下記URLを参照。

「CircleCIサイト＞環境変数の使い方」 +
https://circleci.com/docs/2.0/env-vars/#setting-an-environment-variable-in-a-step
====

==== 実行結果の確認
CircleCI画面では実行されたパイプラインについて、下記の手順でワークフロー単位・Job単位での実行結果の確認を行います。 +
また、エラーが発生した場合には、適宜パイプラインの再実行を設定します。

* サイドバーの「Pipelines」を選択することで、下図のようにパイプライン単位で実行結果を確認することができます。

image::fig_71.png[cicd_result, 640]

[TIP]
====
Pipelines画面の出力結果は、Filterとしてリポジトリ/コミットしたユーザ/ブランチでフィルタリングが可能です。
====

* パイプライン番号横の「▶」を押すと、ワークフローに属するJobごとの結果を確認することができます。

image::fig_72.png[cicd_result, 640]


* パイプライン右の「・・・」を押すと、各パイプラインの設定ファイル（config.yml）の内容を確認することができます。

image::fig_73.png[cicd_result, 640]


[TIP]
====
設定ファイルの見方は、「Source」と「Compiled」があります。

image::fig_74.png[cicd_result, 512]
====


* Pipelines画面でパイプラインの「STATUS」または「WORKFLOW」を押すと下図のようにワークフロー単位での実行結果を確認できます。

image::fig_75.png[cicd_result, 640]


* ワークフロー確認画面で「Return」を押すと下図のように再実行方法や実行停止を選択することができます。

image::fig_76.png[cicd_result, 640]

[TIP]
====
パイプラインが正常終了している場合は、「Rerun Workflow from Start」のみ選択することが可能ですが、異常終了している場合は「Rerun Workflow from Failed」も選択可能です。

image::fig_77.png[cicd_result, 512]
====

* ワークフロー確認画面で「・・・」を押すと下図のように設定ファイル確認とProjectSettingを行うことができます。 +
※画面・内容については、既に説明済みのため省略

image::fig_78.png[cicd_result, 640]


* ワークフロー確認画面で任意のJobを選択すると下図のようにJob単位での実行結果を確認することができます。 +
また、各ステップは「▶」を押すことで展開可能です。

image::fig_79.png[cicd_result, 640]

[TIP]
====
「Spin Up Environment」、「Preparing Environment Variables」については、設定ファイルの記述に関係なく実行されるデフォルトのStepです。 +
それぞれ実行環境の構築と環境変数の読み込みを行うStepです。
====


* Job確認画面で「Return」を押すと下図のようにワークフロー確認画面と同様に再実行方法や実行停止を選択することができます。

image::fig_80.png[cicd_result, 640]


* Job確認画面で「・・・」を押すと下図のようにワークフロー確認画面と同様に設定ファイル確認とProjectSettingを行うことができます。

image::fig_81.png[cicd_result, 640]


* Job確認画面で任意のJobを選択することで、下図のようにJobの内容を確認することができます。

image::fig_82.png[cicd_result, 640]


* Organization所有のリポジトリについて、リポジトリへのアクセス権限によって、パイプラインの操作可能範囲が異なります。

 * リポジトリへのアクセス権限が「参照」の場合、下図に示すようにパイプラインの再実施等のRerun操作は不可能です。

image::fig_83.png[cicd_result, 640]


 * リポジトリへのアクセス権限が「書込み」以上の場合、Rerun操作が可能です。

image::fig_84.png[cicd_result, 640]


このガイドラインでは、2020年4月21日現在の最新画面レイアウトに基づいて説明しましたが、下図のように旧画面レイアウトでCircleCサイトを利用することも可能です。 +
見え方は若干異なっていますが、確認できる内容は前述のものと同じなので直感的に使いやすい方を使えばよいです。

image::fig_85.png[cicd_result, 640]

image::fig_86.png[cicd_result, 640]

image::fig_87.png[cicd_result, 640]


==== 実行結果の発報
パイプライン実行結果をPJのチャットツール（このガイドラインではSlack ）に連携する。

1 Slackの「App」よりCircleCIアプリを追加して、「セットアップの手順」に従ってCircleCIに設定する。

image::fig_31.png[add_slack, 640]

[TIP]
====
実行結果は、下記の方式でCircleCI及びGitHubへのリンク付きで連携される。 +
正常終了した場合は「どのリポジトリ」の「どのブランチ」が「誰が作成したパイプライン」を正常に通過したのか、「コミットしたGitHubユーザ」は誰かを通知する。 +
異常終了した場合は「どのリポジトリ」の「どのブランチ」が「誰が作成したパイプライン」の「どのJob」で異常終了したのか、「コミットしたGitHubユーザ」は誰かを通知する。

image::fig_32.png[add_slack, 640]
====

==== Organizationアカウントのrepositoryを参照するための設定
1 Organizationのリポジトリを登録する場合、自身のアイコンをクリックして「User Setting」画面より設定を行う。

image::fig_41.png[organization, 640]


2 「User Setting」画面で「Account Integrations」→GitHuｂの「Check permissions」を選択して、Github画面を開く。

image::fig_42.png[organization, 640]


3 画面下の「Organization access」に自信が所属しているOrganizationが表示されるので、その内容を確認して「Grant」ボタンを押下する。 +
　この操作でOrganization所有のリポジトリを参照できるようになる。

image::fig_43.png[organization, 640]

image::fig_44.png[organization, 640]

[TIP]
====
Organization所有のリポジトリについては、Organization内での自アカウントの権限によって操作が制限される。

* リポジトリの参照
管理者権限のあるリポジトリについては、個人アカウント同様に「リポジトリの登録」「登録解除」を行うことができる。 +
 ※ただし、リポジトリ解除できるのは自身が登録したリポジトリに限られる。 +
その他のリポジトリについては、「リポジトリの参照」「参照解除」を行うことができる。
 ※ただし、管理者によって登録が解除されているリポジトリについては参照不可（鍵のマークがつく） +
また、GitHub上での権限設定がCircleCIに反映されるまで若干のタイムラグが存在する。

image::fig_45.png[organization, 640]

image::fig_46.png[organization, 640]


* 環境変数の設定
リポジトリへのアクセス権限が「参照」の場合、下図に示すように「ProjectSettings」が非活性になるため環境変数を含め、リポジトリの設定を変更することは不可能です。

image::fig_47.png[organization, 640]

リポジトリへのアクセス権限が「書込み」以上の場合、下図に示すように「ProjectSettings」が活性になるため環境変数を含め、リポジトリの設定を変更することが可能です。

image::fig_48.png[organization, 640]

====
